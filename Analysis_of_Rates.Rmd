---
title: "Analysis of Opioid Prescription, Poverty, and Suicide"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(infer)
library(moderndive)
```

***This is an example problem***

A [recent NPR article](https://www.npr.org/2020/07/17/887590699/doctors-and-dentists-still-flooding-u-s-with-opioid-prescriptions) 
noted that the U.S. is still being flooded with prescription opioid prescriptions by doctors and dentists. 
Upon reading the article, a friend pondered what the provided heat map for prescriptions would look like overlaid 
with suicide and poverty rates. This prompted the question "Is a larger rate of legal opioid prescription related 
to a higher rate of suicides and poverty?"  

To test the conjecture, we found data from the CDC in relation to 
[suicide rates by county](https://wisqars.cdc.gov:8443/cdcMapFramework/mapModuleInterface.jsp), 
[poverty levels by county](https://data.hrsa.gov/tools/data-explorer?ds=29,34), and 
[opioid prescription rate per county](https://www.cdc.gov/drugoverdose/maps/rxrate-maps.html). 
The suicide rate averages were calculated per 100,000 people between 2008 and 2014. Poverty levels 
are percentages of families in the county below intervals of the Federal Poverty Level between 2014 
and 2018. The opioid prescription rate averages were calculated retail opioid prescriptions dispensed 
per 100 persons per year between 2005 and 2015.  

# So far, we have performed individual and multiple regression analysis of all the variables against average 
# prescription rate of opioid. The next step is to look into individual relationships just cause it basic and 
# outlined below for us. Chi-squared tests?

## Check Problem Set 10 and Lab 11 for references to regression, correlation, and generating samples.

What we can calculate: (This is two quantitative variables)
 - proportion of suicides and opioid prescriptions by county population <---- meehhh
 - parameter of interest is regression slope $\beta_1$ and correlation $R$
 - distribution statistic $\hat{\beta}$
    - approximate $t$ value
    - standard error
Infer confidence interval to estimate $\beta_1$
 - data %>% specify(suicide ~ opioid) %>%
 - hypothesize(null = "independence") %>%
 - generate(reps = 1000, type = "permute") %>%
 - calculate(stat = "slope") %>%
 - get_p_value(obs_stat = beta_1, direction = "both")
 
Regression models
  it is only appropriate to make predictions based on a regression model if:
    
  1. The data should show a linear trend.
  
  2. The distribution of residuals is approximately Normal.
  
  3. The residuals have constant variability.
  
### below is mostly the example, but above is the basic format for how we'll do this thing if we 
###analyze one variable at a time against opioid prescription rates. We also have the multiple regression analysis below.

```{r message = FALSE, warning = FALSE}
# Read in data
spo_rate <- read_csv('https://raw.githubusercontent.com/qiqiliang/statistics/master/US_Suicide_Poverty_Opioid_Prescription_Rates') %>%
  select(-X1)
```


*********************************************************************************
Null Hypothesis: There no correlation between suicide, poverty, and opioid prescription rates.
$$H_0: \quad \beta_S = \beta_P = \beta_O = 0$$
Alternate Hypothesis:  There is correlation between suicide, poverty, and opioid prescription rates. 

*********************************************************************************

b. State what a Type I error (reject $H_0$ due to unlikely event) and a Type II 
(reject $H_A$ due to mistaking for unlikely event) error represent in the context of the problem.

*********************************************************************************
 A Type I error represents having some correlation between suicide, poverty, and opioid prescription rates but 
 saying otherwise due to an unlikely event in which all values have had similar spikes over the years 
 (this is BS and should totally be looked at).
 A Type II error would be having no correlation between suicide, poverty, and opioid prescription rates but 
 saying otherwise due to...

*********************************************************************************


c. Construct a graphic and compute summary statistics to explore the sample data.  
Draw some initial conclusions based on your graph and summary statistics.



*********************************************************************************
```{r}
ggplot(spo_rate, aes(x = Avg_Prescr_Rate, y = Avg_Suicide_Rate)) +
  geom_point(alpha = 0.3)+
  geom_smooth(method = lm, se = FALSE) 

m_so <- lm(Avg_Suicide_Rate ~ Avg_Prescr_Rate, data = spo_rate)

m_so_rp <- get_regression_points(m_so) 

ggplot(m_so_rp, aes(x =Avg_Prescr_Rate, y = residual) )+
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)

ggplot(m_so_rp, aes(x = residual) )+
  geom_histogram(binwidth = 1, col = "white")

get_regression_table(m_so)
summary(m_so)

b1_so <- 0.031532
```

Opioid prescription rate may be a statistically significant predictor of suicide rate as the p value 
calculated is less than the significance level $\alpha = 0.05$. The linear model, however, does not 
seems to be too practical, as the adjusted $R^2$ value is only 0.06084. 

```{r}
ggplot(spo_rate, aes(x = Avg_Prescr_Rate, y = AvgP_Below_1.00x_FPL)) +
  geom_point(alpha = 0.3)+
  geom_smooth(method = lm, se = FALSE) 

m_sp1 <- lm(AvgP_Below_1.00x_FPL ~ Avg_Prescr_Rate, data = spo_rate)

m_sp1_rp <- get_regression_points(m_sp1)  

ggplot(m_sp1_rp, aes(x =Avg_Prescr_Rate, y = residual) )+
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)

ggplot(m_sp1_rp, aes(x = residual) )+
  geom_histogram(binwidth = 1, col = "white")

get_regression_table(m_sp1)
summary(m_sp1)

b1_sp1 <- 0.044857
```
Opioid prescription rate may be a statistically significant predictor of the percentage of 
families below 1x the FPL as the p value calculated is less than the significance level 
$\alpha = 0.05$. The linear model, however, does not seems to be too practical, as the adjusted $R^2$ value is 0.1608. 

```{r}
ggplot(spo_rate, aes(x = Avg_Prescr_Rate, y = AvgP_Below_1.50x_FPL)) +
  geom_point(alpha = 0.3)+
  geom_smooth(method = lm, se = FALSE) 

m_sp1_5 <- lm(AvgP_Below_1.50x_FPL ~ Avg_Prescr_Rate, data = spo_rate)

m_sp1_5_rp <- get_regression_points(m_sp1_5)  
ggplot(m_sp1_5_rp, aes(x = Avg_Prescr_Rate, y = residual) )+
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)

ggplot(m_sp1_5_rp, aes(x = residual) )+
  geom_histogram(binwidth = 1, col = "white")

get_regression_table(m_sp1_5)
summary(m_sp1_5)

b1_sp1_5 <- 0.067001
```

Opioid prescription rate may be a statistically significant predictor of the percentage of families 
below 1.5x the FPL as the p value calculated is less than the significance level $\alpha = 0.05$. 
The linear model, however, does not seems to be too practical, as the adjusted $R^2$ value is 0.159. 
```{r}
ggplot(spo_rate, aes(x = Avg_Prescr_Rate, y = AvgP_Below_2.00x_FPL)) +
  geom_point(alpha = 0.3)+
  geom_smooth(method = lm, se = FALSE) 

m_sp2 <- lm(AvgP_Below_2.00x_FPL ~ Avg_Prescr_Rate, data = spo_rate)

m_sp2_rp <- get_regression_points(m_sp2) 

ggplot(m_sp2_rp, aes(x =Avg_Prescr_Rate, y = residual) )+
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)

ggplot(m_sp2_rp, aes(x = residual) )+
  geom_histogram(binwidth = 1, col = "white")

get_regression_table(m_sp2)
summary(m_sp2)

b1_sp2 <- 0.086358
```


*************************


Backward-selection using p-value is a model selection process in which
we start with the full model and consecutively remove the variable 
from the model with highest p-value and refit the model, until all 
variables have p-value at most 0.05 (or another discipline specific
significance level),

Using backward-selection and p-value as the selection criterion,
determine the best model. Write out the
linear model for predicting score based on the final model you
settle on.


```{r}
m_full <- lm(Avg_Prescr_Rate ~ AvgP_Below_2.00x_FPL + 
               AvgP_Below_1.50x_FPL + AvgP_Below_1.00x_FPL + 
               Avg_Suicide_Rate, data = spo_rate)

get_regression_table(m_full)
get_regression_summaries(m_full)
```

Drop the variable with the highest p-value and re-fit the model.

```{r}
m_full <- lm(Avg_Prescr_Rate ~ AvgP_Below_2.00x_FPL + AvgP_Below_1.00x_FPL + Avg_Suicide_Rate, data = spo_rate)

get_regression_table(m_full)
get_regression_summaries(m_full)
```

Drop the variable with the highest p-value and re-fit the model.

```{r}
m_full <- lm(Avg_Prescr_Rate ~ AvgP_Below_1.00x_FPL + Avg_Suicide_Rate, data = spo_rate)

get_regression_table(m_full)
get_regression_summaries(m_full)
```

$$\begin{aligned} \widehat{Avg\_Prescr\_Rate} &= 30.648 + 3.410 \times AvgP\_Below\_1.00x\_FPL 
\\&+ 1.653 \times Avg\_Suicide\_Rate \end{aligned}$$

The interpretation of the coefficients in multiple regression is
slightly different from that of simple regression. The estimate for
`AvgP_Below_1.00x_FPL` reflects how many more prescriptions a county is 
expected to have received if they have percentage of families under two 
times the FPL that is one point higher *while
holding all other variables constant*. In this case, that translates
into considering only counties of the same rank with `AvgP_Below_1.00x_FPL` scores
that are one percent apart.


*********************************************************************************


What we can calculate: (This is two quantitative variables)
 - proportion of suicides and opioid prescriptions by county population <---- meehhh
 - parameter of interest is regression slope $\beta_1$ and correlation $R$
 - distribution statistic $\hat{\beta}$
    - approximate $t$ value
    - standard error
Infer confidence interval to estimate $\beta_1$
 - data %>% specify(suicide ~ opioid) %>%
 - hypothesize(null = "independence") %>%
 - generate(reps = 1000, type = "permute") %>%
 - calculate(stat = "slope") %>%
 - get_p_value(obs_stat = beta_1, direction = "both")
 
Regression models
  it is only appropriate to make predictions based on a regression model if:
    
  1. The data should show a linear trend.
  
  2. The distribution of residuals is approximately Normal.
  
  3. The residuals have constant variability.
 
 
 
 
 
  
d. Generate a null distribution.

*********************************************************************************

Run the following code to generate a null distribution for slopes, assuming
    Suicide Rate and Prescription Rate are independent. Then use `infer` to visualize
    the distribution and compute the p_value. Compare the P-value you get here
    to the one given for slope in the regression table above.
    
```{r}
so_null <- spo_rate %>% 
  specify(Avg_Suicide_Rate ~ Avg_Prescr_Rate) %>%
  hypothesize(null = "independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "slope") 

so_null %>%
  visualize() + 
  shade_p_value(obs_stat = b1_so, direction = "both")
so_null %>%
  get_p_value(obs_stat = b1_so, direction = "both")
```

```{r}
sp1_null <- spo_rate %>% 
  specify(AvgP_Below_1.00x_FPL ~ Avg_Prescr_Rate) %>%
  hypothesize(null = "independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "slope") 

sp1_null %>%
  visualize() + 
  shade_p_value(obs_stat = b1_sp1, direction = "both")
sp1_null %>%
  get_p_value(obs_stat = b1_sp1, direction = "both")
```

```{r}
sp1_5_null <- spo_rate %>% 
  specify(AvgP_Below_1.50x_FPL ~ Avg_Prescr_Rate) %>%
  hypothesize(null = "independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "slope") 

sp1_5_null %>%
  visualize() + 
  shade_p_value(obs_stat = b1_sp1_5, direction = "both")
sp1_5_null %>%
  get_p_value(obs_stat = b1_sp1_5, direction = "both")
```

```{r}
sp2_null <- spo_rate %>% 
  specify(AvgP_Below_2.00x_FPL ~ Avg_Prescr_Rate) %>%
  hypothesize(null = "independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "slope") 

sp2_null %>%
  visualize() + 
  shade_p_value(obs_stat = b1_sp2, direction = "both")
sp2_null %>%
  get_p_value(obs_stat = b1_sp2, direction = "both")
```

If the null hypothesis were true, then the observed slope does not seem plausible because it is an extreme value rather than a more expected value near the center of the distribution. The P-value, assuming a significance level of $\alpha = 0.05$, is 0 when rounded to the thousandth, which means we can reject the null-hypothesis and test for aspects of the alternative. The P-value here and the one generated by the linear regression above is the same when rounded to the thousandth.



e. Generate a bootstrap distribution.

*********************************************************************************


Run the following code to generate a bootstrap distribution for slopes. 
    Then use `infer` and the percentile method to create a 95% confidence interval
    on your slope. Compare the confidence interval here to the one given in the
    regression table above. Finally, assess whether this claim is reasonable
    given your data set.
    
```{r}
twins_boot<-twins %>% 
  specify(Foster ~ Biological) %>% 
  generate(reps = 1000, type = "bootstrap") %>% 
  calculate(stat = "slope")

twins_boot %>%
  get_ci(level = 0.95, type = "percentile")
```


f. Consider Poverty Level as one variable (2x, 1.5x, 1x)

*********************************************************************************
Now consider how the association between suicide rate and opioid prescription rate would change if poverty brackets were taken into account. Create a plot to illustrate the
    relationship between all three variables (recall the use of the
    `color` argument in `aes()`). Just by looking at the plot and
    without fitting any models, does it appear that the relationship
    between the suicide rate and opioid prescription rate is the same for higher poverty counties as it is
    for lower poverty counties?

```{r}
# adding a column for largest poverty bracket
spo_rate_op <- spo_rate %>%
  mutate() # need to finish.

ggplot(spo_rate_op, aes(x = Biological , y = Foster, color = Social))+ 
  geom_point() 
```

*********************************************************************************



More questions to ask:
 - Demographics????
    - Ethnicity, Income
    - Targeting marginalized communities?
    - access to healthcare
